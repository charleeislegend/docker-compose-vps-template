services:
  stremio-streaming-catalogs:
    image: stremio-streaming-catalogs
    container_name: stremio-streaming-catalogs
    restart: unless-stopped
    build:
      context: https://github.com/rleroi/Stremio-Streaming-Catalogs-Addon.git
      dockerfile_inline: |
        # Build Vue app
        FROM node:22.17-alpine AS build
        WORKDIR /app

        # Copy Vue app files
        COPY vue ./vue
        # Remove existing .env files in Vue directory if any
        RUN rm -f ./vue/.env
        RUN rm -f ./vue/.env.development

        ENV VITE_APP_URL=https://${STREMIO_STREAMING_CATALOGS_HOSTNAME?}
        RUN cd vue && npm ci && npm run build

        # Build final production image
        FROM node:22.17-alpine AS production
        RUN apk add --no-cache curl
        WORKDIR /app

        # Copy app files
        COPY index.js .
        COPY addon.js .
        COPY package*.json .

        # Copy built Vue app
        COPY --from=build /app/vue/dist ./vue/dist
        COPY --from=build /app/vue/package*.json ./vue/
        COPY --from=build /app/vue/public ./vue/public

        # Install production dependencies
        RUN npm ci --only=production
        ENV NODE_ENV=production

        EXPOSE ${PORT:-7700}

        HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
        CMD curl -f http://localhost:${PORT:-7700}/manifest.json || exit 1

        ENTRYPOINT ["npm", "start"]
    expose:
      - 7700
    env_file:
      - .env
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.stremio-streaming-catalogs.rule=Host(`${STREMIO_STREAMING_CATALOGS_HOSTNAME?}`)"
      - "traefik.http.routers.stremio-streaming-catalogs.entrypoints=websecure"
      - "traefik.http.routers.stremio-streaming-catalogs.tls.certresolver=letsencrypt"
      - "traefik.http.services.stremio-streaming-catalogs.loadbalancer.server.port=7700"
      - "traefik.http.routers.stremio-streaming-catalogs.middlewares=authelia@docker"
    healthcheck:
      test: "curl -fSs http://localhost:7700/manifest.json || exit 1"
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    profiles:
      - stremio-streaming-catalogs
      - all
